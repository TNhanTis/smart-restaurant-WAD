// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Restaurant {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String   @db.VarChar(100)
  address       String?  @db.Text
  phone         String?  @db.VarChar(20)
  owner_id      String   @db.Uuid
  status        String   @default("active") @db.VarChar(20) // 'active', 'inactive'
  created_at    DateTime @default(now()) @db.Timestamp(6)
  updated_at    DateTime @updatedAt @db.Timestamp(6)
  
  owner           User            @relation(fields: [owner_id], references: [id], onDelete: Cascade)
  tables          Table[]
  menu_categories MenuCategory[]
  modifier_groups ModifierGroup[]
  
  @@index([owner_id])
  @@index([status])
  @@map("restaurants")
}

model Table {
  id                 String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id      String      @db.Uuid
  table_number       String      @db.VarChar(50)
  capacity           Int
  location           String?     @db.VarChar(100)
  description        String?     @db.Text
  status             String      @default("active") @db.VarChar(20)
  qr_token           String?     @db.VarChar(500)
  qr_token_created_at DateTime?   @db.Timestamp(6)
  created_at         DateTime    @default(now()) @db.Timestamp(6)
  updated_at         DateTime    @updatedAt @db.Timestamp(6)

  restaurant         Restaurant  @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  orders             Order[]

  @@unique([restaurant_id, table_number])
  @@index([restaurant_id])
  @@index([status])
  @@index([location])
  @@map("tables")
}

model MenuCategory {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id String      @db.Uuid
  name          String      @db.VarChar(50)
  description   String?     @db.Text
  display_order Int         @default(0)
  status        String      @default("active") @db.VarChar(20)
  created_at    DateTime    @default(now()) @db.Timestamp(6)
  updated_at    DateTime    @updatedAt @db.Timestamp(6)
  
  restaurant    Restaurant  @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  menu_items    MenuItem[]

  @@unique([restaurant_id, name])
  @@index([restaurant_id])
  @@index([status])
  @@map("menu_categories")
}


model MenuItem {
  id                   String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id        String              @db.Uuid
  category_id          String              @db.Uuid
  name                 String              @db.VarChar(80)
  description          String?             @db.Text
  price                Decimal             @db.Decimal(12, 2)
  prep_time_minutes    Int                 @default(0)
  status               String              @db.VarChar(20)
  is_chef_recommended  Boolean             @default(false)
  is_deleted           Boolean             @default(false)
  created_at           DateTime            @default(now()) @db.Timestamp(6)
  updated_at           DateTime            @updatedAt @db.Timestamp(6)
  
  category             MenuCategory        @relation(fields: [category_id], references: [id])
  photos               MenuItemPhoto[]
  modifier_groups      MenuItemModifierGroup[]
  order_items          OrderItem[]

  @@index([restaurant_id])
  @@index([category_id])
  @@index([status])
  @@map("menu_items")
}

model MenuItemPhoto {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  menu_item_id String   @db.Uuid
  url          String   @db.Text
  is_primary   Boolean  @default(false)
  created_at   DateTime @default(now()) @db.Timestamp(6)
  
  menu_item    MenuItem @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)

  @@index([menu_item_id])
  @@map("menu_item_photos")
}

model ModifierGroup {
  id              String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id   String                    @db.Uuid
  name            String                    @db.VarChar(80)
  selection_type  String                    @db.VarChar(20)
  is_required     Boolean                   @default(false)
  min_selections  Int                       @default(0)
  max_selections  Int                       @default(0)
  display_order   Int                       @default(0)
  status          String                    @default("active") @db.VarChar(20)
  created_at      DateTime                  @default(now()) @db.Timestamp(6)
  updated_at      DateTime                  @updatedAt @db.Timestamp(6)
  
  restaurant      Restaurant                @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  options         ModifierOption[]
  menu_items      MenuItemModifierGroup[]

  @@index([restaurant_id])
  @@map("modifier_groups")
}

model ModifierOption {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  group_id         String        @db.Uuid
  name             String        @db.VarChar(80)
  price_adjustment Decimal       @default(0) @db.Decimal(12, 2)
  status           String        @default("active") @db.VarChar(20)
  created_at       DateTime      @default(now()) @db.Timestamp(6)
  
  group            ModifierGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)
  order_item_modifiers OrderItemModifier[]

  @@index([group_id])
  @@map("modifier_options")
}

model MenuItemModifierGroup {
  menu_item_id String        @db.Uuid
  group_id     String        @db.Uuid
  
  menu_item    MenuItem      @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)
  modifier_group ModifierGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)

  @@id([menu_item_id, group_id])
  @@map("menu_item_modifier_groups")
}

model Role {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String   @unique @db.VarChar(50) // 'super_admin', 'admin', 'waiter', 'kitchen', 'customer'
  description String? @db.Text
  created_at DateTime @default(now()) @db.Timestamp(6)
  
  user_roles UserRole[]

  @@map("roles")
}

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String    @unique @db.VarChar(255)
  password_hash String    @db.VarChar(255)
  full_name     String?   @db.VarChar(100)
  phone         String?   @db.VarChar(20)
  status        String    @default("active") @db.VarChar(20) // 'active', 'inactive', 'suspended'
  is_deleted    Boolean   @default(false)
  created_at    DateTime  @default(now()) @db.Timestamp(6)
  updated_at    DateTime  @updatedAt @db.Timestamp(6)
  last_login_at DateTime? @db.Timestamp(6)
  
  user_roles    UserRole[]
  restaurants   Restaurant[]

  @@index([email])
  @@index([status])
  @@map("users")
}

model UserRole {
  user_id    String   @db.Uuid
  role_id    String   @db.Uuid
  created_at DateTime @default(now()) @db.Timestamp(6)
  
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([user_id, role_id])
  @@map("user_roles")
}

enum OrderStatus {
  pending
  accepted
  preparing
  ready
  served
  completed
  cancelled
  rejected
}

model Order {
  id                 String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id      String      @db.Uuid
  table_id           String      @db.Uuid
  customer_id        String?     @db.Uuid
  order_number       String      @unique @db.VarChar(50)
  status             OrderStatus @default(pending)
  subtotal           Decimal     @db.Decimal(12, 2)
  tax                Decimal     @default(0) @db.Decimal(12, 2)
  total              Decimal     @db.Decimal(12, 2)
  special_requests   String?     @db.Text
  created_at         DateTime    @default(now()) @db.Timestamp(6)
  updated_at         DateTime    @updatedAt @db.Timestamp(6)
  accepted_at        DateTime?   @db.Timestamp(6)
  preparing_at       DateTime?   @db.Timestamp(6)
  ready_at           DateTime?   @db.Timestamp(6)
  served_at          DateTime?   @db.Timestamp(6)
  completed_at       DateTime?   @db.Timestamp(6)

  table              Table       @relation(fields: [table_id], references: [id])
  order_items        OrderItem[]

  @@index([restaurant_id])
  @@index([table_id])
  @@index([customer_id])
  @@index([status])
  @@index([created_at])
  @@map("orders")
}

model OrderItem {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id           String              @db.Uuid
  menu_item_id       String              @db.Uuid
  quantity           Int
  unit_price         Decimal             @db.Decimal(12, 2)
  subtotal           Decimal             @db.Decimal(12, 2)
  special_requests   String?             @db.Text
  created_at         DateTime            @default(now()) @db.Timestamp(6)

  order              Order               @relation(fields: [order_id], references: [id], onDelete: Cascade)
  menu_item          MenuItem            @relation(fields: [menu_item_id], references: [id])
  modifiers          OrderItemModifier[]

  @@index([order_id])
  @@index([menu_item_id])
  @@map("order_items")
}

model OrderItemModifier {
  id                 String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_item_id      String         @db.Uuid
  modifier_option_id String         @db.Uuid
  price_adjustment   Decimal        @db.Decimal(12, 2)
  created_at         DateTime       @default(now()) @db.Timestamp(6)

  order_item         OrderItem      @relation(fields: [order_item_id], references: [id], onDelete: Cascade)
  modifier_option    ModifierOption @relation(fields: [modifier_option_id], references: [id])

  @@index([order_item_id])
  @@index([modifier_option_id])
  @@map("order_item_modifiers")
}
