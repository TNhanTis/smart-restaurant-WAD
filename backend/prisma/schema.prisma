generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Restaurant {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String          @db.VarChar(100)
  address         String?
  phone           String?         @db.VarChar(20)
  owner_id        String          @db.Uuid
  status          String          @default("active") @db.VarChar(20)
  created_at      DateTime        @default(now()) @db.Timestamp(6)
  updated_at      DateTime        @updatedAt @db.Timestamp(6)
  bill_requests   bill_requests[]
  menu_categories MenuCategory[]
  modifier_groups ModifierGroup[]
  owner           User            @relation(fields: [owner_id], references: [id], onDelete: Cascade)
  tables          Table[]

  @@index([owner_id])
  @@index([status])
  @@map("restaurants")
}

model Table {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  table_number        String          @db.VarChar(50)
  capacity            Int
  location            String?         @db.VarChar(100)
  description         String?
  status              String          @default("active") @db.VarChar(20)
  qr_token            String?         @db.VarChar(500)
  qr_token_created_at DateTime?       @db.Timestamp(6)
  created_at          DateTime        @default(now()) @db.Timestamp(6)
  updated_at          DateTime        @updatedAt @db.Timestamp(6)
  restaurant_id       String          @db.Uuid
  bill_requests       bill_requests[]
  orders              Order[]
  restaurant          Restaurant      @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)

  @@unique([restaurant_id, table_number])
  @@index([restaurant_id])
  @@index([status])
  @@index([location])
  @@map("tables")
}

model MenuCategory {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id String     @db.Uuid
  name          String     @db.VarChar(50)
  description   String?
  display_order Int        @default(0)
  status        String     @default("active") @db.VarChar(20)
  created_at    DateTime   @default(now()) @db.Timestamp(6)
  updated_at    DateTime   @updatedAt @db.Timestamp(6)
  restaurant    Restaurant @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  menu_items    MenuItem[]

  @@unique([restaurant_id, name])
  @@index([restaurant_id])
  @@index([status])
  @@map("menu_categories")
}

model MenuItem {
  id                  String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id       String                  @db.Uuid
  category_id         String                  @db.Uuid
  name                String                  @db.VarChar(80)
  description         String?
  price               Decimal                 @db.Decimal(12, 2)
  prep_time_minutes   Int                     @default(0)
  status              String                  @db.VarChar(20)
  is_chef_recommended Boolean                 @default(false)
  is_deleted          Boolean                 @default(false)
  created_at          DateTime                @default(now()) @db.Timestamp(6)
  updated_at          DateTime                @updatedAt @db.Timestamp(6)
  cart_items          cart_items[]
  modifier_groups     MenuItemModifierGroup[]
  photos              MenuItemPhoto[]
  category            MenuCategory            @relation(fields: [category_id], references: [id])
  order_items         OrderItem[]
  reviews             reviews[]

  @@index([restaurant_id])
  @@index([category_id])
  @@index([status])
  @@map("menu_items")
}

model MenuItemPhoto {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  menu_item_id String   @db.Uuid
  url          String
  is_primary   Boolean  @default(false)
  created_at   DateTime @default(now()) @db.Timestamp(6)
  menu_item    MenuItem @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)

  @@index([menu_item_id])
  @@map("menu_item_photos")
}

model ModifierGroup {
  id             String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id  String                  @db.Uuid
  name           String                  @db.VarChar(80)
  selection_type String                  @db.VarChar(20)
  is_required    Boolean                 @default(false)
  min_selections Int                     @default(0)
  max_selections Int                     @default(0)
  display_order  Int                     @default(0)
  status         String                  @default("active") @db.VarChar(20)
  created_at     DateTime                @default(now()) @db.Timestamp(6)
  updated_at     DateTime                @updatedAt @db.Timestamp(6)
  menu_items     MenuItemModifierGroup[]
  restaurant     Restaurant              @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  options        ModifierOption[]

  @@index([restaurant_id])
  @@map("modifier_groups")
}

model ModifierOption {
  id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  group_id             String                @db.Uuid
  name                 String                @db.VarChar(80)
  price_adjustment     Decimal               @default(0) @db.Decimal(12, 2)
  status               String                @default("active") @db.VarChar(20)
  created_at           DateTime              @default(now()) @db.Timestamp(6)
  cart_item_modifiers  cart_item_modifiers[]
  group                ModifierGroup         @relation(fields: [group_id], references: [id], onDelete: Cascade)
  order_item_modifiers OrderItemModifier[]

  @@index([group_id])
  @@map("modifier_options")
}

model MenuItemModifierGroup {
  menu_item_id   String        @db.Uuid
  group_id       String        @db.Uuid
  modifier_group ModifierGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)
  menu_item      MenuItem      @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)

  @@id([menu_item_id, group_id])
  @@map("menu_item_modifier_groups")
}

model Role {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String     @unique @db.VarChar(50)
  description String?
  created_at  DateTime   @default(now()) @db.Timestamp(6)
  user_roles  UserRole[]

  @@map("roles")
}

model User {
  id                                   String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                                String          @unique @db.VarChar(255)
  password_hash                        String          @db.VarChar(255)
  full_name                            String?         @db.VarChar(100)
  phone                                String?         @db.VarChar(20)
  status                               String          @default("active") @db.VarChar(20)
  is_deleted                           Boolean         @default(false)
  created_at                           DateTime        @default(now()) @db.Timestamp(6)
  updated_at                           DateTime        @updatedAt @db.Timestamp(6)
  last_login_at                        DateTime?       @db.Timestamp(6)
  bill_requests                        bill_requests[]
  notifications                        notifications[]
  orders                               Order[]
  payments_payments_received_byTousers payments[]      @relation("payments_received_byTousers")
  payments_payments_refunded_byTousers payments[]      @relation("payments_refunded_byTousers")
  restaurants                          Restaurant[]
  reviews                              reviews[]
  user_roles                           UserRole[]

  @@index([email])
  @@index([status])
  @@map("users")
}

model UserRole {
  user_id    String   @db.Uuid
  role_id    String   @db.Uuid
  created_at DateTime @default(now()) @db.Timestamp(6)
  role       Role     @relation(fields: [role_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([user_id, role_id])
  @@map("user_roles")
}

model Order {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id    String      @db.Uuid
  table_id         String      @db.Uuid
  customer_id      String?     @db.Uuid
  order_number     String      @unique @db.VarChar(50)
  status           OrderStatus @default(pending)
  subtotal         Decimal     @db.Decimal(12, 2)
  tax              Decimal     @default(0) @db.Decimal(12, 2)
  total            Decimal     @db.Decimal(12, 2)
  special_requests String?
  created_at       DateTime    @default(now()) @db.Timestamp(6)
  updated_at       DateTime    @updatedAt @db.Timestamp(6)
  accepted_at      DateTime?   @db.Timestamp(6)
  preparing_at     DateTime?   @db.Timestamp(6)
  ready_at         DateTime?   @db.Timestamp(6)
  served_at        DateTime?   @db.Timestamp(6)
  completed_at     DateTime?   @db.Timestamp(6)
  waiter_id        String?     @db.Uuid
  order_items      OrderItem[]
  waiter           User?       @relation(fields: [waiter_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_orders_waiter")
  table            Table       @relation(fields: [table_id], references: [id])
  payments         payments[]

  @@index([restaurant_id])
  @@index([table_id])
  @@index([customer_id])
  @@index([status])
  @@index([created_at])
  @@index([waiter_id], map: "idx_orders_waiter_id")
  @@map("orders")
}

model OrderItem {
  id               String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id         String              @db.Uuid
  menu_item_id     String              @db.Uuid
  quantity         Int
  unit_price       Decimal             @db.Decimal(12, 2)
  subtotal         Decimal             @db.Decimal(12, 2)
  special_requests String?
  created_at       DateTime            @default(now()) @db.Timestamp(6)
  modifiers        OrderItemModifier[]
  menu_item        MenuItem            @relation(fields: [menu_item_id], references: [id])
  order            Order               @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([order_id])
  @@index([menu_item_id])
  @@map("order_items")
}

model OrderItemModifier {
  id                 String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_item_id      String         @db.Uuid
  modifier_option_id String         @db.Uuid
  price_adjustment   Decimal        @db.Decimal(12, 2)
  created_at         DateTime       @default(now()) @db.Timestamp(6)
  modifier_option    ModifierOption @relation(fields: [modifier_option_id], references: [id])
  order_item         OrderItem      @relation(fields: [order_item_id], references: [id], onDelete: Cascade)

  @@index([order_item_id])
  @@index([modifier_option_id])
  @@map("order_item_modifiers")
}

model cart_item_modifiers {
  id                 String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cart_item_id       String         @db.Uuid
  modifier_option_id String         @db.Uuid
  created_at         DateTime?      @default(now()) @db.Timestamp(6)
  cart_items         cart_items     @relation(fields: [cart_item_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  modifier_options   ModifierOption @relation(fields: [modifier_option_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([cart_item_id], map: "idx_cart_item_modifiers_cart_item_id")
  @@index([modifier_option_id], map: "idx_cart_item_modifiers_modifier_option_id")
}

model cart_items {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cart_id             String                @db.Uuid
  menu_item_id        String                @db.Uuid
  quantity            Int
  special_requests    String?
  created_at          DateTime?             @default(now()) @db.Timestamp(6)
  updated_at          DateTime?             @default(now()) @db.Timestamp(6)
  cart_item_modifiers cart_item_modifiers[]
  carts               carts                 @relation(fields: [cart_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  menu_items          MenuItem              @relation(fields: [menu_item_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([cart_id], map: "idx_cart_items_cart_id")
  @@index([menu_item_id], map: "idx_cart_items_menu_item_id")
}

model carts {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customer_id String?      @db.Uuid
  session_id  String       @db.VarChar(255)
  created_at  DateTime?    @default(now()) @db.Timestamp(6)
  updated_at  DateTime?    @default(now()) @db.Timestamp(6)
  cart_items  cart_items[]

  @@index([customer_id], map: "idx_carts_customer_id")
  @@index([session_id], map: "idx_carts_session_id")
}

model notifications {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  type       String   @db.VarChar(50)
  title      String   @db.VarChar(255)
  message    String
  data       Json?
  is_read    Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamp(6)
  users      User     @relation(fields: [user_id], references: [id])

  @@index([created_at])
  @@index([is_read])
  @@index([user_id])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model payment_methods {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code          String     @unique @db.VarChar(20)
  name          String     @db.VarChar(50)
  description   String?
  logo_url      String?    @db.VarChar(255)
  is_active     Boolean?   @default(true)
  config        Json?
  display_order Int?       @default(0)
  created_at    DateTime?  @default(now()) @db.Timestamp(6)
  updated_at    DateTime?  @default(now()) @db.Timestamp(6)
  payments      payments[]
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model payments {
  id                                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id                          String?         @db.Uuid
  payment_method_id                 String          @db.Uuid
  amount                            Decimal         @db.Decimal(10, 2)
  status                            String?         @default("pending") @db.VarChar(20)
  gateway_request_id                String?         @db.VarChar(100)
  gateway_trans_id                  String?         @db.VarChar(100)
  gateway_response                  Json?
  received_by                       String?         @db.Uuid
  cash_amount                       Decimal?        @db.Decimal(10, 2)
  change_amount                     Decimal?        @db.Decimal(10, 2)
  notes                             String?
  completed_at                      DateTime?       @db.Timestamp(6)
  failed_reason                     String?
  refund_reason                     String?
  refunded_at                       DateTime?       @db.Timestamp(6)
  refunded_by                       String?         @db.Uuid
  created_at                        DateTime?       @default(now()) @db.Timestamp(6)
  updated_at                        DateTime?       @default(now()) @db.Timestamp(6)
  bill_request_id                   String?         @db.Uuid
  merged_order_ids                  Json?
  tips_amount                       Decimal?        @default(0) @db.Decimal(12, 2)
  bill_requests                     bill_requests?  @relation(fields: [bill_request_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  orders                            Order?          @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payment_methods                   payment_methods @relation(fields: [payment_method_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_payments_received_byTousers User?           @relation("payments_received_byTousers", fields: [received_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_payments_refunded_byTousers User?           @relation("payments_refunded_byTousers", fields: [refunded_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([created_at], map: "idx_payments_created")
  @@index([gateway_request_id], map: "idx_payments_gateway_request")
  @@index([payment_method_id], map: "idx_payments_method")
  @@index([order_id], map: "idx_payments_order")
  @@index([status], map: "idx_payments_status")
  @@index([bill_request_id], map: "idx_payments_bill_request")
}

model bill_requests {
  id                  String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id       String     @db.Uuid
  table_id            String     @db.Uuid
  payment_method_code String     @db.VarChar(20)
  subtotal            Decimal    @db.Decimal(12, 2)
  tips_amount         Decimal?   @default(0) @db.Decimal(12, 2)
  total_amount        Decimal    @db.Decimal(12, 2)
  order_ids           Json
  customer_note       String?
  status              String?    @default("pending") @db.VarChar(20)
  accepted_by         String?    @db.Uuid
  accepted_at         DateTime?  @db.Timestamp(6)
  created_at          DateTime?  @default(now()) @db.Timestamp(6)
  updated_at          DateTime?  @default(now()) @db.Timestamp(6)
  users               User?      @relation(fields: [accepted_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  restaurants         Restaurant @relation(fields: [restaurant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tables              Table      @relation(fields: [table_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payments            payments[]

  @@index([created_at], map: "idx_bill_requests_created")
  @@index([restaurant_id], map: "idx_bill_requests_restaurant")
  @@index([restaurant_id, status], map: "idx_bill_requests_restaurant_status")
  @@index([status], map: "idx_bill_requests_status")
  @@index([table_id], map: "idx_bill_requests_table")
}

model reviews {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  menu_item_id String   @db.Uuid
  user_id      String   @db.Uuid
  rating       Int      @default(5)
  comment      String?
  created_at   DateTime @default(now()) @db.Timestamp(6)
  updated_at   DateTime @db.Timestamp(6)
  menu_items   MenuItem @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)
  users        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([menu_item_id])
  @@index([user_id])
}

enum OrderStatus {
  pending
  accepted
  preparing
  ready
  served
  completed
  cancelled
  rejected
}
